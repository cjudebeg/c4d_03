{% extends "layouts/b_box.html" %}
{% load custom_filters %}
{% load static %}

{% block content %}
<div class="w-full">
    <!-- External libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script defer src="https://unpkg.com/@alpinejs/ui@3.14.9/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/@alpinejs/focus@3.14.9/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.14.9/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>

    <!-- Styles -->
    <style>
        [x-cloak]{display:none!important}
        .text-truncate{max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block}
        @media(min-width:640px){.text-truncate{max-width:320px}}
        @media(min-width:768px){.text-truncate{max-width:380px}}
        .toast-enter{opacity:1;transition:opacity .3s ease}
        .toast-leave{opacity:0;transition:opacity .3s ease}
        .required-star{color:#dc2626;margin-left:0.15rem}
    </style>

    <!-- Alpine tooltip helper -->
    <script>
      document.addEventListener('alpine:init', () => {
        Alpine.magic('tooltip', el => msg => {
          const t = tippy(el, { content: msg, trigger: 'manual' }); t.show();
          setTimeout(() => { t.hide(); setTimeout(() => t.destroy(), 150) }, 2000);
        });
        Alpine.directive('tooltip', (el, { expression }) => tippy(el, { content: expression }));
      });
    </script>

    <!-- Page header & clearance banner -->
    <h2 class="text-2xl font-bold mb-4 lg:mb-6">Profile</h2>
    <div class="flex flex-col md:flex-row justify-between">
      <p class="text-sm text-gray-600 mb-3">Fields marked with <span class="required-star">*</span> are required.</p>
      {% if profile.clearance_valid == "PENDING" %}
        <div class="border border-amber-200 bg-orange-100 p-4 text-sm max-w-lg mb-6 text-wrap">
          You will be able to view available job opportunities once the clearance verification is complete.
        </div>
      {% elif profile.clearance_valid == "NO" %}
        <div class="border border-red-400 bg-red-100 text-black p-4 text-sm max-w-lg mb-6 text-wrap">
          We could not verify your clearance. Please contact administration.
        </div>
      {% endif %}
    </div>

    <!-- ===================== ACCOUNT SECTION ===================== -->
    <div class="border-t border-b border-gray-200 py-4">
        <div class="lg:grid lg:grid-cols-4">
          <div class="col-span-1 invisible lg:visible"><h3 class="text-lg font-semibold">Account</h3></div>
  
          <div class="col-span-3">
            <!-- mobile edit -->
            <div class="flex justify-between items-center mb-3 lg:hidden">
              <h3 class="text-lg font-semibold">Account</h3>
              <button id="toggle-email-btn" onclick="toggleEmailInput()" class="text-blue-600 hover:underline">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 -960 960 960" fill="#1f1f1f">
                  <path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6
                           q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Z"/>
                </svg>
              </button>
            </div>
            <!-- desktop edit -->
            <div class="hidden lg:flex justify-end mb-3">
              <button id="toggle-email-btn-lg" onclick="toggleEmailInput()" class="text-blue-600 hover:underline">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 -960 960 960" fill="#1f1f1f">
                  <path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6
                           q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Z"/>
                </svg>
              </button>
            </div>
  
            <!-- email display -->
            <div id="email-display-section" class="mb-4">
              <div class="flex flex-col">
                <span id="current-email" class="text-gray-700 text-truncate" title="{{ user.email|default:'Not provided' }}">
                  {{ user.email|default:'Not provided' }}
                </span>
                <span id="verification-status"
                      class="{% if user.emailaddress_set.first and user.emailaddress_set.first.verified %}text-green-500{% else %}text-amber-500{% endif %} mt-1">
                  {% if user.emailaddress_set.first and user.emailaddress_set.first.verified %}
                    <span class="font-semibold">Verified</span>
                  {% else %}Not verified{% endif %}
                </span>
              </div>
              <div id="verification-action"
                   class="{% if user.emailaddress_set.first and user.emailaddress_set.first.verified %}hidden{% else %}block{% endif %} mt-2">
                <button type="button" onclick="sendVerificationEmail()"
                        class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-transparent p-0">
                  Send verification email
                </button>
              </div>
            </div>
  
            <!-- email change -->
            <div id="email-form-container" style="display:none" class="mb-6">
              <div class="mb-3 text-lg font-semibold">Edit Email</div>
  
              {% csrf_token %}
              <div class="flex flex-col space-y-2">
                <input id="id_new_email" name="new_email" type="email" required placeholder="Enter new email address"
                       class="bg-gray-200 border border-gray-300 px-3 py-2 w-full sm:w-3/4 md:max-w-md">
                <div class="flex space-x-2">
                  <button id="email-change-submit" type="button"
                          class="bg-blue-500 text-white px-4 py-2 text-sm">Update</button>
                  <button type="button" onclick="toggleEmailInput()" class="bg-gray-500 text-white px-4 py-2 text-sm">
                    Cancel
                  </button>
                </div>
              </div>
              <div id="email-form-message" class="mt-2 text-sm"></div>
            </div>
  
            <!-- change-password -->
            <div class="flex justify-end">
              <a href="{% url 'account_change_password' %}"
                 class="text-blue-600 hover:text-blue-800 text-sm font-medium">Change password</a>
            </div>
          </div>
        </div>
      </div>

<!-- ===================== PERSONAL SECTION ===================== -->
<div class="border-b border-gray-200 py-4">
    <div class="lg:grid lg:grid-cols-4 lg:gap-4">
      <div class="col-span-1 invisible lg:visible">
        <h3 class="text-lg font-semibold">Personal</h3>
      </div>
      <div class="col-span-3">
        <!-- mobile header + edit -->
        <div class="flex justify-between items-center mb-3 lg:hidden">
          <h3 class="text-lg font-semibold">Personal</h3>
          <button id="personal-edit-btn"
                  onclick="toggleSection('personal')"
                  class="text-blue-600 hover:underline">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                 viewBox="0 -960 960 960" fill="#1f1f1f">
              <path d="M200-200h57l391-391-57-57-391 391v57Zm-80
                       80v-170l528-527q12-11 26.5-17t30.5-6q16 0
                       31 6t26 18l55 56q12 11 17.5 26t5.5 30q0
                       16-5.5 30.5T817-647L290-120H120Z"/>
            </svg>
          </button>
        </div>
        <!-- desktop edit -->
        <div class="hidden lg:flex justify-end mb-3">
          <button id="personal-edit-btn-lg"
                  onclick="toggleSection('personal')"
                  class="text-blue-600 hover:underline">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                 viewBox="0 -960 960 960" fill="#1f1f1f">
              <path d="M200-200h57l391-391-57-57-391 391v57Zm-80
                       80v-170l528-527q12-11 26.5-17t30.5-6q16 0
                       31 6t26 18l55 56q12 11 17.5 26t5.5 30q0
                       16-5.5 30.5T817-647L290-120H120Z"/>
            </svg>
          </button>
        </div>
  
        <!-- display -->
        <div id="personal-display">
          <div class="text-gray-700">
            {{ profile.first_name|default:"Not provided"|capfirst }}
            {% if profile.middle_name %} {{ profile.middle_name|capfirst }}{% endif %}
            {{ profile.last_name|default:"Not provided"|capfirst }}
          </div>
          <div class="text-gray-700 mt-1">
            {% if profile.suburb and profile.state %}{{ profile.suburb }}, {% endif %}
            {% if profile.state %}{{ profile.state }}{% else %}No location provided{% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Inline PERSONAL form (includes name-change) -->
  <form id="personal-form"
        action="{% url 'profile_update_personal' %}"
        method="POST"
        style="display:none"
        class="border-b border-gray-200 py-6 mb-6"
        x-data="{
          openName:false,
          newFirst:'', newMiddle:'', newLast:'', reason:'', sending:false,
          currentFirst:'{{ profile.first_name|default_if_none:''|escapejs }}',
          currentMiddle:'{{ profile.middle_name|default_if_none:''|escapejs }}',
          currentLast:'{{ profile.last_name|default_if_none:''|escapejs }}'
        }">
    {% csrf_token %}
  
    <div class="lg:w-2/3 lg:mx-auto">
  
      <!-- centred heading -->
      <div class="mb-3 text-lg font-semibold">Edit Personal Information</div>
  
      <!-- two-column grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium">First name<span class="required-star">*</span></label>
          <input readonly
                 value="{{ profile.first_name }}"
                 class="w-full border bg-gray-100 px-2 py-1 text-gray-500 cursor-not-allowed">
        </div>
        <div>
          <label class="block text-sm font-medium">Middle name</label>
          <input readonly
                 value="{{ profile.middle_name }}"
                 class="w-full border bg-gray-100 px-2 py-1 text-gray-500 cursor-not-allowed">
        </div>
        <div>
          <label class="block text-sm font-medium">Last name<span class="required-star">*</span></label>
          <input readonly
                 value="{{ profile.last_name }}"
                 class="w-full border bg-gray-100 px-2 py-1 text-gray-500 cursor-not-allowed">
        </div>
        <div>
          <label class="block text-sm font-medium">Suburb</label>
          <input name="suburb"
                 id="id_suburb"
                 value="{{ profile.suburb }}"
                 placeholder="Enter suburb"
                 class="w-full border bg-gray-200 px-2 py-1">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium">State</label>
          {% with "New South Wales,Victoria,Queensland,Western Australia,South Australia,Tasmania,Northern Territory,Australian Capital Territory"|split:"," as states %}
          <select name="state"
                  id="id_state"
                  class="w-full border bg-gray-200 px-2 py-1 max-w-xs">
            <option value="">Select state</option>
            {% for val in states %}
              <option value="{{ val }}"
                {% if profile.state|lower == val|lower or profile.state|lower == val|slice:":3"|lower %}
                  selected
                {% endif %}>
                {{ val }}
              </option>
            {% endfor %}
          </select>
          {% endwith %}
        </div>
      </div>
  
      <!-- name-change trigger -->
      <div class="mb-4">
        <a href="#"
           x-show="!openName"
           x-cloak
           @click.prevent="openName = true"
           class="text-blue-600 text-sm hover:underline">
          Request Name Change
        </a>
      </div>
  
      <!-- name-change accordion -->
      <div x-show="openName" x-cloak class="border border-gray-300 bg-gray-50 p-4 mb-4">
        <div class="mb-2 font-semibold text-sm">
          Name-change request
          <span x-data x-tooltip="Provide new name and reason"
                class="ml-2 text-blue-500 cursor-pointer">(i)</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium">New first name<span class="required-star">*</span></label>
            <input x-model="newFirst" class="w-full border bg-white px-2 py-1">
          </div>
          <div>
            <label class="block text-sm font-medium">New middle name</label>
            <input x-model="newMiddle" class="w-full border bg-white px-2 py-1">
          </div>
          <div>
            <label class="block text-sm font-medium">New last name<span class="required-star">*</span></label>
            <input x-model="newLast" class="w-full border bg-white px-2 py-1">
          </div>
        </div>
        <label class="block text-sm font-medium mb-1">Reason for change</label>
        <textarea x-model="reason" rows="3" class="w-full border bg-white px-2 py-1 mb-4"></textarea>
        <div class="flex space-x-2">
          <button type="button"
                  class="bg-green-600 text-white px-4 py-2 text-sm"
                  :disabled="sending"
                  @click="
                    const f=newFirst.trim(), l=newLast.trim();
                    if(!f||!l){ showToast('Both first and last names are required.'); return; }
                    if(f.toLowerCase()===currentFirst.toLowerCase() &&
                       l.toLowerCase()===currentLast.toLowerCase() &&
                       newMiddle.trim().toLowerCase()===currentMiddle.toLowerCase()){
                         showToast('New name must differ from current name.'); return; }
                    if(!reason.trim()){ showToast('Please provide a reason.'); return; }
                    sending=true;
                    fetch('{% url 'profile_request_name_change' %}', {
                      method:'POST',
                      headers:{
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With':'XMLHttpRequest'
                      },
                      body: new URLSearchParams({
                        new_first: f,
                        new_middle: newMiddle.trim(),
                        new_last: l,
                        reason: reason.trim()
                      })
                    }).then(r=>r.json()).then(d=>{
                      showToast(d.message);
                      if(d.success){ openName=false; newFirst=''; newMiddle=''; newLast=''; reason=''; }
                    }).catch(()=>{
                      showToast('Error sending request.');
                    }).finally(()=>{
                      sending=false;
                    });
                  ">
            Send Request
          </button>
          <button type="button"
                  class="bg-gray-500 text-white px-4 py-2 text-sm"
                  @click="openName=false">
            Cancel
          </button>
        </div>
      </div>
  
      <!-- Save/Cancel -->
      <div class="flex space-x-2">
        <button type="submit" class="bg-blue-500 text-white px-4 py-2">Save</button>
        <button type="button"
                onclick="toggleSection('personal',true)"
                class="bg-gray-500 text-white px-4 py-2">
          Cancel
        </button>
      </div>
    </div>
  </form>

    <!-- ===================== SECURITY CLEARANCE SECTION ===================== -->
    <div class="border-b border-gray-200 py-4">
      <div class="lg:grid lg:grid-cols-4 lg:gap-4">
        <div class="col-span-1 invisible lg:visible">
          <h3 class="text-lg font-semibold">Security Clearance</h3>
        </div>
        <div class="col-span-3">
          <!-- mobile -->
          <div class="flex justify-between items-center mb-3 lg:hidden">
            <h3 class="text-lg font-semibold">Security Clearance</h3>
            <button id="security-edit-btn" onclick="toggleSection('security')" class="text-blue-600 hover:underline">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                   viewBox="0 -960 960 960" fill="#1f1f1f">
                <path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6
                         q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Z"/>
              </svg>
            </button>
          </div>
          <!-- desktop -->
          <div class="hidden lg:flex justify-end mb-3">
            <button id="security-edit-btn-lg" onclick="toggleSection('security')" class="text-blue-600 hover:underline">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                   viewBox="0 -960 960 960" fill="#1f1f1f">
                <path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6
                         q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Z"/>
              </svg>
            </button>
          </div>
          <!-- display -->
          <div id="security-display">
            <div class="text-gray-700 flex items-center space-x-2">
              <span class="text-truncate" title="{{ profile.clearance_no|default:'No CSID' }}">
                {{ profile.clearance_no|default:'No CSID' }}
              </span>
              {% if profile.clearance_valid == "YES" %}
                <span class="text-green-500 font-semibold">Valid</span>
              {% elif profile.clearance_valid == "PENDING" %}
                <span class="text-amber-500 font-semibold">Pending</span>
              {% else %}
                <span class="text-red-500 font-semibold">Invalid</span>
              {% endif %}
            </div>
            <div class="text-gray-700 mt-1">
              {% if profile.clearance_active %}
                <span class="text-green-500 font-semibold">Active</span>
              {% else %}
                <span class="text-red-500 font-semibold">Inactive</span>
              {% endif %}
            </div>
            <div class="text-gray-700 mt-1">{{ profile.clearance_level|default:'No level' }}</div>
            <div class="text-gray-700 mt-1">
              {% if profile.clearance_revalidation %}
                Re-validation date: {{ profile.clearance_revalidation|date:"d/m/Y" }}
              {% else %}No re-validation date{% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Inline SECURITY form -->
    <form id="security-form"
          action="{% url 'profile_update_security' %}"
          method="POST"
          style="display:none"
          class="border-b border-gray-200 py-6 mb-6">
      {% csrf_token %}
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4 mb-4 lg:w-2/3 lg:mx-auto">
        <div class="md:col-span-2 lg:col-span-2 mb-3 text-lg font-semibold">
          Edit Security Clearance
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">CSID Number</label>
          <input readonly value="{{ profile.clearance_no|default:'No CSID' }}"
                 class="w-full border bg-gray-100 px-4 py-3 text-gray-500 cursor-not-allowed">
        </div>
        <div>
          <label for="id_clearance_level" class="block text-sm font-medium text-gray-700">AGSVA Level</label>
          <select name="clearance_level" id="id_clearance_level"
                  class="w-full border bg-gray-200 px-4 py-3">
            {% for opt in "None,Pending,Baseline,NV1,NV2,PV"|split:"," %}
              <option value="{{ opt }}" {% if profile.clearance_level == opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="md:col-span-2 lg:col-span-2 flex space-x-4">
          <button class="bg-blue-500 text-white px-4 py-2" type="submit">Save</button>
          <button class="bg-gray-500 text-white px-4 py-2" type="button" onclick="toggleSection('security',true)">Cancel</button>
        </div>
      </div>
    </form>

    <!-- ===================== SKILLS SECTION ===================== -->
    <div class="border-b border-gray-200 py-4">
        <div class="lg:grid lg:grid-cols-4 lg:gap-4">
          <div class="col-span-1 invisible lg:visible"><h3 class="text-lg font-semibold">Skills</h3></div>
  
          <div class="col-span-3">
            <div class="flex justify-between items-center mb-3 lg:hidden">
              <h3 class="text-lg font-semibold">Skills</h3>
              <button id="skills-edit-btn" onclick="toggleSection('skills')" class="text-blue-600 hover:underline">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                     viewBox="0 -960 960 960" fill="#1f1f1f">
                  <path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6
                           q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Z"/>
                </svg>
              </button>
            </div>
            <div class="hidden lg:flex justify-end mb-3">
              <button id="skills-edit-btn-lg" onclick="toggleSection('skills')" class="text-blue-600 hover:underline">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                     viewBox="0 -960 960 960" fill="#1f1f1f">
                  <path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6
                           q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Z"/>
                </svg>
              </button>
            </div>
  
            <!-- skills display -->
            <div id="skills-display">
              <div class="text-gray-700">
                {% if profile.skill_sets %}
                  {% with skill_list=profile.skill_sets|split:"," %}
                    <span class="hidden md:inline" title="{{ profile.skill_sets }}">
                      {{ skill_list|join:", " }}
                    </span>
                    <span class="md:hidden truncate" title="{{ profile.skill_sets }}">
                      {% if skill_list|length > 1 %}
                        {{ skill_list.0 }} and {{ skill_list|length|add:"-1" }} more
                      {% else %}
                        {{ skill_list.0 }}
                      {% endif %}
                    </span>
                  {% endwith %}
                {% else %}
                  No skills selected
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
  
      <!-- Inline SKILLS form -->
      <form id="skills-form"
      action="{% url 'profile_update_skills' %}"
      method="POST"
      style="display:none"
      class="border-b border-gray-200 py-6 mb-6">
      {% csrf_token %}
  
      <div class="
      grid grid-cols-1
      md:grid-cols-2
      lg:grid-cols-2
      gap-4 mb-4
      lg:w-1/3 lg:mx-auto         
      ">
  
      <!-- Title (centred at lg) -->
      <div class="md:col-span-2 lg:col-span-2 mb-3 text-lg font-semibold">
      Edit Skills
      </div>
  
      <!-- ‘Skills’ label + tooltip (spans both columns so it stays above input) -->
      <div class="md:col-span-2 lg:col-span-2 flex items-center mb-2">
      <span class="text-sm font-medium">Skills</span>
      <span x-data x-tooltip="Select all relevant specialisations"
          class="ml-2 text-blue-500 cursor-pointer text-sm">(i)</span>
      </div>
  
      <!-- Multi-select -->
      <div class="md:col-span-2 lg:col-span-2">
      <div x-data="{
              open:false,
              values:[],
              industries:[
              {id:1,name:'Business Process & Improvement'},
              {id:2,name:'Change & Transition Management'},
              {id:3,name:'Commercial & Procurement'},
              {id:4,name:'Configuration & Data Management'},
              {id:5,name:'Consulting & Advisory'},
              {id:6,name:'HR & Workforce'},
              {id:7,name:'Logistics & Supply Chain'},
              {id:8,name:'Project & Program Management'},
              {id:9,name:'Quality, Certification & Audit'},
              {id:10,name:'Risk, Cost & Financial Analysis'},
              {id:11,name:'Specialist - Aviation & Space'},
              {id:12,name:'Specialist - Training & Development'}
              ],
              get label(){return this.values.length===0 ? 'Choose skills…'
                              : (this.values.length===1 ? this.values[0].name
                              : `${this.values.length} selected`)},
              init(){
              const initial='{{ profile.skill_sets|default_if_none:""|escapejs }}';
              if(initial.trim()){
                  const arr=initial.split(',').map(s=>s.trim());
                  this.values=this.industries.filter(ind=>arr.includes(ind.name));
              }
              },
              isSel(i){return this.values.some(v=>v.id===i.id)},
              toggle(i){
              const idx=this.values.findIndex(v=>v.id===i.id);
              idx===-1 ? this.values.push(i) : this.values.splice(idx,1);
              }
          }"
          x-init="init()"
          class="relative w-full">
  
      <button type="button" @click="open=!open"
              class="w-full flex items-center justify-between gap-2 border border-gray-300 bg-gray-200 px-3 py-2">
          <span x-text="label" class="text-black"></span>
          <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd"
                  d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293
                  a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 0 010-1.414z"
                  clip-rule="evenodd"/>
          </svg>
      </button>
  
      <div x-show="open" x-cloak @click.away="open=false"
          class="absolute z-10 mt-1 w-full bg-white shadow-lg border
                  border-gray-300 max-h-60 overflow-y-auto">
          <ul class="py-1">
          <template x-for="i in industries" :key="i.id">
              <li @click="toggle(i);$event.stopPropagation()"
                  :class="{'bg-blue-50':isSel(i)}"
                  class="px-3 py-2 cursor-pointer hover:bg-gray-100 flex items-center">
              <div class="mr-2 h-5 w-5 flex items-center justify-center border"
                  :class="isSel(i)?'bg-blue-500 border-blue-500':'border-gray-300'">
                  <svg x-show="isSel(i)" class="h-3 w-3 text-white"
                      xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                      fill="currentColor">
                  <path fill-rule="evenodd"
                          d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4
                          a1 0 011.414-1.414L8 12.586l7.293-7.293a1 0 011.414 0z"
                          clip-rule="evenodd"/>
                  </svg>
              </div>
              <span x-text="i.name"></span>
              </li>
          </template>
          </ul>
      </div>
  
      <template x-for="v in values" :key="v.id">
          <input type="hidden" name="skill_sets_multiple" :value="v.name">
      </template>
      </div>
      </div>
  
      <!-- Buttons row (centred on lg) -->
      <div class="md:col-span-2 lg:col-span-2 flex justify-start space-x-4 mt-4">
      <button class="bg-blue-500 text-white px-4 py-2" type="submit">Save</button>
      <button class="bg-gray-500 text-white px-4 py-2"
              type="button" onclick="toggleSection('skills',true)">
      Cancel
      </button>
      </div>
  
      </div>
      </form>
    
    <!-- DELETE ACCOUNT -->
    <div class="mt-8 flex">
      <a href="{% url 'profile-delete' %}" class="border border-red-500 text-red-500 px-4 py-2">Delete Account</a>
    </div>

    <!-- toast container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50"></div>
</div>

<!-- Toast helper -->
<script>
  function showToast(msg){
    const t=document.createElement('div');
    t.className='toast-enter fixed top-4 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-4 py-2 shadow-lg z-50 flex items-center';
    t.innerHTML=`<span>${msg}</span><button class="ml-4 font-bold">&times;</button>`;
    t.querySelector('button').onclick=()=>t.remove();
    document.body.appendChild(t);
    setTimeout(()=>t.classList.replace('toast-enter','toast-leave'),4000);
    setTimeout(()=>t.remove(),4500);
  }
</script>

<!-- Section toggle & email AJAX -->
<script>
  let currentOpenSection = null, emailCloseTimer = null;

  function toggleSection(section, cancel = false) {
    // auto-close account email form if opening other section
    if (section !== 'email') toggleEmailInput(true);

    const form = document.getElementById(section + '-form'),
          display = document.getElementById(section + '-display'),
          btn   = document.getElementById(section + '-edit-btn'),
          btnLg = document.getElementById(section + '-edit-btn-lg');
    if (!form || !display) return;

    // close on cancel or if already open
    if (cancel || currentOpenSection === section) {
      form.style.display = 'none';
      display.style.display = 'block';
      currentOpenSection = null;
      return;
    }
    // close previously open section
    if (currentOpenSection) toggleSection(currentOpenSection, true);

    // open this section
    form.style.display = 'block';
    display.style.display = 'none';
    currentOpenSection = section;
  }

  function toggleEmailInput(force = false) {
    if (emailCloseTimer) { clearTimeout(emailCloseTimer); emailCloseTimer = null; }
    const c = document.getElementById('email-form-container'),
          d = document.getElementById('email-display-section');
    if (force || c.style.display === 'block') {
      c.style.display = 'none';
      d.style.display = 'block';
      document.getElementById('email-form-message').innerHTML = '';
      document.getElementById('id_new_email').value = '';
      if (currentOpenSection === 'email') currentOpenSection = null;
      return;
    }
    if (currentOpenSection && currentOpenSection !== 'email') toggleSection(currentOpenSection, true);
    c.style.display = 'block';
    d.style.display = 'none';
    currentOpenSection = 'email';
  }

  document.getElementById('email-change-submit').addEventListener('click', () => {
    const email = document.getElementById('id_new_email').value,
          msg   = document.getElementById('email-form-message'),
          csrf  = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch("{% url 'profile-emailchange' %}", {
      method: 'POST',
      headers: {'X-Requested-With':'XMLHttpRequest','X-CSRFToken':csrf},
      body: new URLSearchParams({email})
    }).then(r=>r.json()).then(d=>{
      if (d.success) {
        msg.innerHTML = `<div class="text-green-600">${d.message}</div>`;
        document.getElementById('current-email').textContent = d.email;
        const vs = document.getElementById('verification-status');
        vs.textContent = 'Not verified';
        vs.className = 'text-amber-500 mt-1';
        document.getElementById('verification-action').classList.remove('hidden');
        emailCloseTimer = setTimeout(()=>toggleEmailInput(true),4000);
      } else {
        msg.innerHTML = `<div class="text-red-600">${d.message}</div>`;
      }
    }).catch(()=>{ msg.innerHTML = '<div class="text-red-600">An error occurred.</div>'; });
  });

  function sendVerificationEmail(){
    fetch("{% url 'profile-emailverify' %}", {
      method:'POST',
      headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':'{{ csrf_token }}'}
    }).then(r=>r.json()).then(d=>showToast(d.message))
      .catch(()=>showToast('Failed to send verification email.'));
  }
</script>
{% endblock %}
