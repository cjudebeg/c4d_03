{% extends "layouts/b_box.html" %}
{% load custom_filters %}
{% load static %}

{% block content %}
<div class="w-full">
  <!-- Tailwind & Font Awesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>

  <!-- Alpine.js â€“ core last -->
  <script defer src="https://unpkg.com/@alpinejs/ui@3.14.9/dist/cdn.min.js"></script>
  <script defer src="https://unpkg.com/@alpinejs/focus@3.14.9/dist/cdn.min.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.14.9/dist/cdn.min.js"></script>

  <!-- Tippy.js -->
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>

  <!-- x-cloak + truncation -->
  <style>
    [x-cloak]{display:none!important}
    .text-truncate{max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block}
    @media(min-width:640px){.text-truncate{max-width:320px}}
    @media(min-width:768px){.text-truncate{max-width:380px}}
  </style>

  <!-- tooltip helper -->
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.magic('tooltip', el => msg => {
        const t=tippy(el,{content:msg,trigger:'manual'}); t.show();
        setTimeout(()=>{t.hide(); setTimeout(()=>t.destroy(),150)},2000);
      });
      Alpine.directive('tooltip',(el,{expression})=>{ tippy(el,{content:expression}) });
    });
  </script>

  <!-- PAGE HEADER -->
  <h2 class="text-2xl font-bold mb-1 lg:mb-2">Profile</h2>
  <p class="text-sm text-gray-600 mb-4">Fields marked with <span class="text-red-600">*</span> are required.</p>

  {% if profile.clearance_valid == "PENDING" %}
    <div class="mb-6 p-4 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded">
      You will be able to view available job opportunities once the clearance verification is complete.
    </div>
  {% elif profile.clearance_valid == "NO" %}
    <div class="mb-6 p-4 bg-red-100 border border-red-400 text-red-800 rounded">
      We could not verify your clearance. Please contact administration.
    </div>
  {% endif %}

  <!-- ===================== ACCOUNT ===================== -->
  <div class="border-b py-4 w-full">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-semibold text-lg">Account</h3>
      <button id="toggle-email-btn" onclick="toggleEmailInput()"
              class="text-blue-600 font-medium hover:underline">EDIT</button>
    </div>

    <div id="email-display-section" class="mb-4">
      <div class="flex flex-col">
        <span id="current-email" class="text-gray-700 text-truncate"
              title="{% if user.email %}{{ user.email }}{% else %}Not provided{% endif %}">
          {% if user.email %}{{ user.email }}{% else %}Not provided{% endif %}
        </span>
        <span id="verification-status"
              class="{% if user.emailaddress_set.first and user.emailaddress_set.first.verified %}text-green-500{% else %}text-amber-500{% endif %} mt-1">
          {% if user.emailaddress_set.first and user.emailaddress_set.first.verified %}
            <span class="font-semibold">Verified</span>
          {% else %}
            Not verified
          {% endif %}
        </span>
      </div>
      <div id="verification-action"
           class="{% if user.emailaddress_set.first and user.emailaddress_set.first.verified %}hidden{% else %}block{% endif %} mt-2">
        <button type="button" onclick="sendVerificationEmail()"
                class="text-blue-600 hover:text-blue-800 font-medium text-sm bg-transparent p-0">
          Send verification email
        </button>
      </div>
    </div>

    <div id="email-form-container" style="display:none" class="mb-6">
      {% csrf_token %}
      <div class="flex flex-col space-y-2">
        <input id="id_new_email" type="email" name="new_email" required
               placeholder="Enter new email address"
               class="bg-white px-3 py-2 border border-gray-300 w-full bg-gray-200">
        <div class="flex space-x-2">
          <button id="email-change-submit" type="button"
                  class="bg-blue-500 text-white px-4 py-2 text-sm">Update</button>
          <button type="button" onclick="toggleEmailInput()"
                  class="bg-gray-500 text-white px-4 py-2 text-sm">Cancel</button>
        </div>
      </div>
      <div id="email-form-message" class="mt-2 text-sm"></div>
    </div>

    <div class="flex">
      <a href="{% url 'account_change_password' %}"
         class="text-blue-600 hover:text-blue-800 font-medium text-sm">Change password</a>
    </div>
  </div>

  <!-- ===================== PERSONAL ===================== -->
  <div class="border-b py-4 w-full">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-semibold text-lg">Personal</h3>
      <button id="personal-edit-btn" onclick="toggleSection('personal')"
              class="text-blue-600 font-medium hover:underline">EDIT</button>
    </div>

    <div id="personal-display">
      <div class="text-gray-700">
        {% if profile.first_name %}{{ profile.first_name }}{% else %}Not provided{% endif %}
        {% if profile.middle_name %} {{ profile.middle_name }}{% endif %}
        {% if profile.last_name %} {{ profile.last_name }}{% else %}Not provided{% endif %}
      </div>
      <div class="text-gray-700 mt-1">
        {% if profile.suburb and profile.state %}
          {{ profile.suburb }},
          {% if profile.state == "NSW" or profile.state == "New South Wales" %}New South Wales
          {% elif profile.state == "VIC" or profile.state == "Victoria" %}Victoria
          {% elif profile.state == "QLD" or profile.state == "Queensland" %}Queensland
          {% elif profile.state == "WA"  or profile.state == "Western Australia" %}Western Australia
          {% elif profile.state == "SA"  or profile.state == "South Australia" %}South Australia
          {% elif profile.state == "TAS" or profile.state == "Tasmania" %}Tasmania
          {% elif profile.state == "NT"  or profile.state == "Northern Territory" %}Northern Territory
          {% elif profile.state == "ACT" or profile.state == "Australian Capital Territory" %}Australian Capital Territory
          {% else %}{{ profile.state }}{% endif %}
        {% elif profile.suburb %}
          {{ profile.suburb }}
        {% elif profile.state %}
          {% if profile.state == "NSW" or profile.state == "New South Wales" %}New South Wales
          {% elif profile.state == "VIC" or profile.state == "Victoria" %}Victoria
          {% elif profile.state == "QLD" or profile.state == "Queensland" %}Queensland
          {% elif profile.state == "WA"  or profile.state == "Western Australia" %}Western Australia
          {% elif profile.state == "SA"  or profile.state == "South Australia" %}South Australia
          {% elif profile.state == "TAS" or profile.state == "Tasmania" %}Tasmania
          {% elif profile.state == "NT"  or profile.state == "Northern Territory" %}Northern Territory
          {% elif profile.state == "ACT" or profile.state == "Australian Capital Territory" %}Australian Capital Territory
          {% else %}{{ profile.state }}{% endif %}
        {% else %}
          No location provided
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Inline Personal Form -->
  <form id="personal-form" action="{% url 'profile_update_personal' %}" method="POST"
        style="display:none" class="border-b py-4"
        x-data="{ openName:false, newFirst:'', newLast:'', reason:'', sending:false, feedback:'' }">
    {% csrf_token %}
    <div class="mb-3 font-semibold text-lg">Edit Personal Information</div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">
          First name<span class="text-red-600">*</span>
        </label>
        <input readonly placeholder="Read only"
               type="text" name="first_name" id="id_first_name_personal"
               value="{{ profile.first_name|default_if_none:'' }}"
               class="w-full border border-gray-300 px-3 py-2 bg-gray-100 text-gray-500 cursor-not-allowed" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Middle name</label>
        <input readonly placeholder="Read only"
               type="text" name="middle_name" id="id_middle_name_personal"
               value="{{ profile.middle_name|default_if_none:'' }}"
               class="w-full border border-gray-300 px-3 py-2 bg-gray-100 text-gray-500 cursor-not-allowed">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">
          Last name<span class="text-red-600">*</span>
        </label>
        <input readonly placeholder="Read only"
               type="text" name="last_name" id="id_last_name_personal"
               value="{{ profile.last_name|default_if_none:'' }}"
               class="w-full border border-gray-300 px-3 py-2 bg-gray-100 text-gray-500 cursor-not-allowed" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Suburb</label>
        <input placeholder="Enter suburb"
               type="text" name="suburb" id="id_suburb"
               value="{{ profile.suburb|default_if_none:'' }}"
               class="w-full border border-gray-300 px-3 py-2 bg-gray-200">
      </div>
      <div>
        <label for="id_state" class="block text-sm font-medium text-gray-700">State</label>
        <select name="state" id="id_state"
                class="w-full border border-gray-300 px-3 py-2 bg-gray-200">
          <option value="">Select state</option>
          <option value="New South Wales" {% if profile.state == 'NSW' or profile.state == 'New South Wales' %}selected{% endif %}>New South Wales</option>
          <option value="Victoria"        {% if profile.state == 'VIC' or profile.state == 'Victoria'        %}selected{% endif %}>Victoria</option>
          <option value="Queensland"      {% if profile.state == 'QLD' or profile.state == 'Queensland'      %}selected{% endif %}>Queensland</option>
          <option value="Western Australia" {% if profile.state == 'WA'  or profile.state == 'Western Australia' %}selected{% endif %}>Western Australia</option>
          <option value="South Australia" {% if profile.state == 'SA'  or profile.state == 'South Australia'  %}selected{% endif %}>South Australia</option>
          <option value="Tasmania"        {% if profile.state == 'TAS' or profile.state == 'Tasmania'        %}selected{% endif %}>Tasmania</option>
          <option value="Northern Territory" {% if profile.state == 'NT'  or profile.state == 'Northern Territory' %}selected{% endif %}>Northern Territory</option>
          <option value="Australian Capital Territory" {% if profile.state == 'ACT' or profile.state == 'Australian Capital Territory' %}selected{% endif %}>Australian Capital Territory</option>
        </select>
      </div>
    </div>

    <!-- Name-change request -->
    <button type="button"
            class="bg-blue-500 text-white px-4 py-2 mb-4"
            @click="openName=!openName">
      Request Name Change
    </button>

    <div x-show="openName" x-cloak class="border border-gray-300 p-4 mb-4 bg-gray-50">
      <div class="mb-2 font-semibold text-sm">
        Name-change request
        <span x-data x-tooltip="Provide new name and reason"
              class="ml-2 text-blue-500 cursor-pointer">(i)</span>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">New first name</label>
          <input x-model="newFirst"
                 type="text"
                 class="w-full border border-gray-300 px-3 py-2 bg-white">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">New last name</label>
          <input x-model="newLast"
                 type="text"
                 class="w-full border border-gray-300 px-3 py-2 bg-white">
        </div>
      </div>

      <label class="block text-sm font-medium text-gray-700 mb-1">Reason for change</label>
      <textarea x-model="reason" rows="3"
                class="w-full border border-gray-300 px-3 py-2 bg-white mb-4"></textarea>

      <div class="flex space-x-2">
        <button type="button"
                class="bg-green-600 text-white px-4 py-2"
                :disabled="sending"
                @click="
                  if(!newFirst && !newLast){feedback='Enter a new name.';return}
                  if(!reason){feedback='Provide a reason.';return}
                  sending=true;
                  const csrf=document.querySelector('[name=csrfmiddlewaretoken]').value;
                  fetch('{% url 'profile_request_name_change' %}',{
                    method:'POST',
                    headers:{'X-CSRFToken':csrf,'X-Requested-With':'XMLHttpRequest'},
                    body:new URLSearchParams({new_first:newFirst,new_last:newLast,reason:reason})
                  }).then(r=>r.json()).then(d=>{
                      feedback=d.message;
                      if(d.success){openName=false; newFirst=''; newLast=''; reason='';}
                  }).catch(()=>{feedback='Error sending request.'})
                    .finally(()=>sending=false);
                ">
          Send Request
        </button>
        <button type="button"
                class="bg-gray-500 text-white px-4 py-2"
                @click="openName=false;feedback=''">
          Cancel
        </button>
      </div>
      <div class="text-sm mt-2" x-text="feedback"></div>
    </div>

    <div class="flex space-x-2">
      <button type="submit" class="bg-blue-500 text-white px-4 py-2">Save</button>
      <button type="button"
              onclick="toggleSection('personal',true)"
              class="bg-gray-500 text-white px-4 py-2">Cancel</button>
    </div>
  </form>

  <!-- ===================== SECURITY CLEARANCE ===================== -->
  <div class="border-b py-4 w-full">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-semibold text-lg">Security Clearance</h3>
      <!-- <button id="security-edit-btn"
              onclick="toggleSection('security')"
              class="text-blue-600 font-medium hover:underline">EDIT</button> -->
    </div>

    <div id="security-display">
      <div class="text-gray-700 flex items-center space-x-2">
        <span class="text-truncate"
              title="{% if profile.clearance_no %}{{ profile.clearance_no }}{% else %}No CSID{% endif %}">
          {% if profile.clearance_no %}{{ profile.clearance_no }}{% else %}No CSID{% endif %}
        </span>
        {% if profile.clearance_valid == "YES" %}
          <span class="text-green-500 font-semibold">Valid</span>
        {% elif profile.clearance_valid == "PENDING" %}
          <!-- pending -->
        {% else %}
          <span class="text-red-500 font-semibold">Invalid</span>
        {% endif %}
      </div>
      <div class="text-gray-700 mt-1">
        {% if profile.clearance_active %}
          <span class="text-green-500 font-semibold">Active</span>
        {% else %}
          <span class="text-red-500 font-semibold">Inactive</span>
        {% endif %}
      </div>
      <div class="text-gray-700 mt-1">
        {% if profile.clearance_level %}{{ profile.clearance_level }}{% else %}No level{% endif %}
      </div>
      <div class="text-gray-700 mt-1">
        {% if profile.clearance_revalidation %}
          Re-validation date: {{ profile.clearance_revalidation|date:"d/m/Y" }}
        {% else %}
          No re-validation date
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Inline Security Form -->
  <form id="security-form" action="{% url 'profile_update_security' %}" method="POST"
        style="display:none" class="border-b py-4">
    {% csrf_token %}
    <div class="mb-3 font-semibold text-lg">Edit Clearance</div>

    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700">CSID Number</label>
      <input readonly placeholder="Read only"
             type="text"
             value="{% if profile.clearance_no %}{{ profile.clearance_no }}{% else %}Not provided{% endif %}"
             class="w-full border border-gray-300 px-3 py-2 bg-gray-100 text-gray-500 cursor-not-allowed">
    </div>

    <div class="mb-4">
      <label for="id_clearance_level" class="block text-sm font-medium text-gray-700">
        AGSVA Level
      </label>
      <!-- not required & disabled -->
      <select name="clearance_level" id="id_clearance_level" disabled
              class="w-full border border-gray-300 px-3 py-2 bg-gray-100 text-gray-500 cursor-not-allowed">
        <option value=""  {% if not profile.clearance_level %}selected{% endif %}>Select clearance level</option>
        <option value="None"     {% if profile.clearance_level == "None"     %}selected{% endif %}>None</option>
        <option value="Pending"  {% if profile.clearance_level == "Pending"  %}selected{% endif %}>Pending</option>
        <option value="Baseline" {% if profile.clearance_level == "Baseline" %}selected{% endif %}>Baseline</option>
        <option value="NV1"      {% if profile.clearance_level == "NV1"      %}selected{% endif %}>NV1</option>
        <option value="NV2"      {% if profile.clearance_level == "NV2"      %}selected{% endif %}>NV2</option>
        <option value="PV"       {% if profile.clearance_level == "PV"       %}selected{% endif %}>PV</option>
      </select>
    </div>

    <!-- Save / Cancel stay for future editable fields but do nothing to AGSVA Level -->
    <div class="flex space-x-2">
      <button type="submit" class="bg-blue-500 text-white px-4 py-2">Save</button>
      <button type="button"
              onclick="toggleSection('security',true)"
              class="bg-gray-500 text-white px-4 py-2">Cancel</button>
    </div>
  </form>

  <!-- ===================== SKILLS ===================== -->
  <div class="border-b py-4 w-full">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-semibold text-lg">Skills</h3>
      <button id="skills-edit-btn"
              onclick="toggleSection('skills')"
              class="text-blue-600 font-medium hover:underline">EDIT</button>
    </div>
    <div id="skills-display">
      <div class="text-gray-700">
        {% if profile.skill_sets %}
          {% with skill_list=profile.skill_sets|split:"," %}
            <span class="hidden md:inline" title="{{ profile.skill_sets }}">{{ skill_list|join:", " }}</span>
            <span class="truncate md:hidden" title="{{ profile.skill_sets }}">
              {% if skill_list|length > 1 %}
                {{ skill_list.0 }} and {{ skill_list|length|add:"-1" }} more
              {% else %}
                {{ skill_list.0 }}
              {% endif %}
            </span>
          {% endwith %}
        {% else %}
          No skills selected
        {% endif %}
      </div>
      <!-- <div class="text-gray-700 mt-1">
        {% if profile.skill_level %}{{ profile.skill_level }}{% else %}No skill level{% endif %}
      </div> -->
    </div>
  </div>

  <!-- Inline Skills Form -->
  <form id="skills-form" action="{% url 'profile_update_skills' %}" method="POST"
        style="display:none" class="py-4 w-full">
    {% csrf_token %}
    <div class="mb-3 font-semibold text-lg">Edit Skills</div>

    <div class="flex items-center mb-2">
      <span class="text-sm font-medium text-gray-700">Skills</span>
      <span x-data x-tooltip="Select all relevant specialisations"
            class="ml-2 text-blue-500 cursor-pointer text-sm font-bold">(i)</span>
    </div>

    <div x-data="{
            open:false,
            values:[],
            industries:[
              {id:1,name:'Business Process & Improvement'},
              {id:2,name:'Change & Transition Management'},
              {id:3,name:'Commercial & Procurement'},
              {id:4,name:'Configuration & Data Management'},
              {id:5,name:'Consulting & Advisory'},
              {id:6,name:'HR & Workforce'},
              {id:7,name:'Logistics & Supply Chain'},
              {id:8,name:'Project & Program Management'},
              {id:9,name:'Quality, Certification & Audit'},
              {id:10,name:'Risk, Cost & Financial Analysis'},
              {id:11,name:'Specialist - Aviation & Space'},
              {id:12,name:'Specialist - Training & Development'}
            ],
            get label(){return this.values.length===0?'Choose skills...':(this.values.length===1?this.values[0].name:`${this.values.length} selected`)},
            init(){
              const initial='{{ profile.skill_sets|default_if_none:""|escapejs }}';
              if(initial.trim()){
                const arr=initial.split(',').map(s=>s.trim());
                this.values=this.industries.filter(ind=>arr.includes(ind.name));
              }
            },
            isSel(i){return this.values.some(v=>v.id===i.id)},
            toggle(i){
              const idx=this.values.findIndex(v=>v.id===i.id);
              idx===-1 ? this.values.push(i) : this.values.splice(idx,1);
            }
          }" x-init="init()" class="relative w-full">

      <button type="button" @click="open=!open"
              class="w-full flex items-center justify-between gap-2 border border-gray-300 bg-gray-200 px-3 py-2">
        <span x-text="label" class="text-black"></span>
        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg"
             viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd"
                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 0 010-1.414z"
                clip-rule="evenodd"/>
        </svg>
      </button>

      <div x-show="open" x-cloak @click.away="open=false"
           class="absolute z-10 mt-1 w-full bg-white shadow-lg border border-gray-300 max-h-60 overflow-y-auto">
        <ul class="py-1">
          <template x-for="i in industries" :key="i.id">
            <li @click="toggle(i);$event.stopPropagation()"
                :class="{'bg-blue-50':isSel(i)}"
                class="px-3 py-2 cursor-pointer hover:bg-gray-100 flex items-center">
              <div class="mr-2 h-5 w-5 flex items-center justify-center border"
                   :class="isSel(i)?'bg-blue-500 border-blue-500':'border-gray-300'">
                <svg x-show="isSel(i)" class="h-3 w-3 text-white" xmlns="http://www.w3.org/2000/svg"
                     viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd"
                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 0 011.414-1.414L8 12.586l7.293-7.293a1 0 011.414 0z"
                        clip-rule="evenodd"/>
                </svg>
              </div>
              <span x-text="i.name"></span>
            </li>
          </template>
        </ul>
      </div>

      <template x-for="v in values" :key="v.id">
        <input type="hidden" name="skill_sets_multiple" :value="v.name">
      </template>
    </div>

    <!-- <div class="mt-4">
      <label for="id_skill_level" class="block text-sm font-medium text-gray-700 mb-1">Skill Level</label>
      <select name="skill_level" id="id_skill_level"
              class="w-full border border-gray-300 px-3 py-2 bg-gray-200">
        <option value="">Select experience level</option>
        <option value="Junior" {% if profile.skill_level == "Junior" %}selected{% endif %}>Junior</option>
        <option value="Mid"    {% if profile.skill_level == "Mid"    %}selected{% endif %}>Mid</option>
        <option value="Senior" {% if profile.skill_level == "Senior" %}selected{% endif %}>Senior</option>
      </select>
    </div> -->

    <div class="flex space-x-2 mt-4">
      <button type="submit" class="bg-blue-500 text-white px-4 py-2">Save</button>
      <button type="button"
              onclick="toggleSection('skills',true)"
              class="bg-gray-500 text-white px-4 py-2">Cancel</button>
    </div>
  </form>

  <!-- DELETE ACCOUNT -->
  <div class="mt-6 text-left">
    <a href="{% url 'profile-delete' %}"
       class="bg-white border border-red-500 text-red-500 py-2 px-4 inline-block">
      Delete Account
    </a>
  </div>
</div>

<!-- ========== JS helpers ========== -->
<script>
  let currentOpenSection=null;

  function toggleSection(section,cancel=false){
    if(cancel){
      const f=document.getElementById(section+'-form');
      const d=document.getElementById(section+'-display');
      const b=document.getElementById(section+'-edit-btn');
      if(f)f.style.display='none';
      if(d)d.style.display='block';
      if(b)b.style.display='block';
      currentOpenSection=null;
      return;
    }
    if(currentOpenSection && currentOpenSection!==section){
      const pf=document.getElementById(currentOpenSection+'-form');
      const pd=document.getElementById(currentOpenSection+'-display');
      const pb=document.getElementById(currentOpenSection+'-edit-btn');
      if(pf)pf.style.display='none';
      if(pd)pd.style.display='block';
      if(pb)pb.style.display='block';
      if(currentOpenSection==='email')toggleEmailInput(true);
    }
    const d=document.getElementById(section+'-display');
    const f=document.getElementById(section+'-form');
    const b=document.getElementById(section+'-edit-btn');
    if(!d||!f)return;
    d.style.display='none';
    f.style.display='block';
    if(b)b.style.display='none';
    currentOpenSection=section;
  }

  function toggleEmailInput(forceClose=false){
    if(window.emailCloseTimer){clearTimeout(window.emailCloseTimer);window.emailCloseTimer=null;}
    const c=document.getElementById('email-form-container');
    const d=document.getElementById('email-display-section');
    const b=document.getElementById('toggle-email-btn');
    if(forceClose || c.style.display==='block'){
      c.style.display='none'; d.style.display='block'; if(b)b.style.display='block';
      document.getElementById('email-form-message').innerHTML='';
      document.getElementById('id_new_email').value='';
      if(currentOpenSection==='email')currentOpenSection=null;
      return;
    }
    if(currentOpenSection && currentOpenSection!=='email'){toggleSection(currentOpenSection,true);}
    c.style.display='block'; d.style.display='none'; if(b)b.style.display='none';
    currentOpenSection='email';
  }

  document.getElementById('email-change-submit').addEventListener('click',()=>{
    const email=document.getElementById('id_new_email').value;
    const msg=document.getElementById('email-form-message');
    const csrf=document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch("{% url 'profile-emailchange' %}",{
      method:'POST',
      headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':csrf},
      body:new URLSearchParams({email})
    }).then(r=>r.json()).then(d=>{
      if(d.success){
        msg.innerHTML=`<div class="text-green-600">${d.message}</div>`;
        document.getElementById('current-email').textContent=d.email;
        const vs=document.getElementById('verification-status');
        vs.textContent='Not verified'; vs.className='text-amber-500 mt-1';
        document.getElementById('verification-action').classList.remove('hidden');
        window.emailCloseTimer=setTimeout(()=>{toggleEmailInput(true); window.emailCloseTimer=null;},4000);
      }else{
        msg.innerHTML=`<div class="text-red-600">${d.message}</div>`;
      }
    }).catch(()=>{msg.innerHTML='<div class="text-red-600">An error occurred. Please try again.</div>';});
  });

  function sendVerificationEmail(){
    fetch("{% url 'profile-emailverify' %}",{
      method:'POST',
      headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':'{{ csrf_token }}'}
    }).then(r=>r.json()).then(d=>{
      const va=document.getElementById('verification-action');
      const tmp=document.createElement('div');
      tmp.className='text-green-600 text-sm';
      tmp.textContent=d.message;
      const orig=va.innerHTML;
      va.innerHTML='';
      va.appendChild(tmp);
      setTimeout(()=>{va.innerHTML=orig},3000);
    }).catch(()=>{alert('Failed to send verification email. Please try again.');});
  }

  document.addEventListener('DOMContentLoaded',()=>{
    ['first_name','middle_name','last_name'].forEach(id=>{
      const el=document.getElementById('id_'+id+'_personal');
      if(el && !el.readOnly){ el.placeholder='Enter '+id.replace('_',' '); }
    });
  });
</script>
{% endblock %}
